<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECE Event Creator | Draft</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Base Tailwind Directives */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css');
        
        /* Custom Components (from styles.css) */
        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }

        .btn-primary {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #2563EB; /* blue-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 150ms;
        }
        .btn-primary:hover {
            background-color: #1D4ED8; /* blue-700 */
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #E5E7EB; /* gray-200 */
            color: #374151; /* gray-700 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 150ms;
        }
        .btn-secondary:hover {
            background-color: #D1D5DB; /* gray-300 */
        }
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-ghost {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4B5563; /* gray-600 */
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 150ms;
        }
        .btn-ghost:hover {
            background-color: #F3F4F6; /* gray-100 */
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151; /* gray-700 */
            margin-bottom: 0.25rem;
        }

        .form-group input:not([type="radio"]):not([type="checkbox"]),
        .form-group select,
        .file-input {
            width: 100%;
            border: 1px solid #D1D5DB; /* gray-300 */
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            padding: 0.5rem;
            transition: border-color 150ms, box-shadow 150ms;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #3B82F6; /* blue-500 */
            --tw-ring-color: #3B82F6;
            box-shadow: 0 0 0 1px #3B82F6;
            outline: 2px solid transparent;
        }
        
        .form-group .error-message {
            font-size: 0.75rem;
            color: #EF4444; /* red-500 */
            margin-top: 0.25rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6B7280; /* gray-500 */
            border-bottom-width: 2px;
            border-color: transparent;
            transition: color 150ms, border-color 150ms;
            display: flex;
            align-items: center;
        }

        .tab:hover {
            color: #2563EB; /* blue-600 */
            border-color: #93C5FD; /* blue-300 */
        }

        .tab-active {
            color: #2563EB; /* blue-600 */
            border-color: #2563EB;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1F2937; /* gray-800 */
            margin-bottom: 1rem;
            border-bottom: 1px solid #E5E7EB;
            padding-bottom: 0.5rem;
        }
        
        .radio-label {
            display: inline-flex;
            align-items: center;
        }
        .radio-label input[type="radio"] {
            height: 1rem;
            width: 1rem;
            color: #2563EB;
            border-color: #D1D5DB;
            margin-right: 0.5rem;
        }
        
        /* Tag Styles */
        .tag-item {
            background-color: #DBEAFE; /* blue-100 */
            color: #1E40AF; /* blue-800 */
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px; /* full */
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .tag-remove {
            cursor: pointer;
            color: #2563EB;
        }
        .tag-remove:hover {
            color: #1E40AF;
        }
        
        /* Mobile Preview Styling */
        @media (max-width: 1023px) {
            #event-preview-content {
                transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
                overflow: hidden;
            }
            #event-preview-content.hidden-mobile {
                max-height: 0;
                opacity: 0;
            }
            #event-preview-content:not(.hidden-mobile) {
                max-height: 1000px; /* Large enough value */
                opacity: 1;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 font-poppins text-gray-800">

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    <div id="snackbar-container" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50"></div>

    <div class="container mx-auto p-4 lg:p-8">
        <header class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between">
            <div id="breadcrumbs" class="text-sm text-gray-500 hidden sm:block">
                ECE Association / <span class="font-medium text-gray-700">New Event Draft</span>
            </div>
            <div id="header-actions" class="space-x-2 mt-4 sm:mt-0 flex">
                <span id="autosave-timestamp" class="text-xs text-gray-400 self-center hidden lg:block"></span>
                <button type="button" id="save-draft-btn" class="btn-ghost">
                    <i data-lucide="save" class="w-4 h-4 mr-1"></i> Save Draft
                </button>
                <button type="button" id="publish-btn" class="btn-primary">
                    <span id="publish-spinner" class="hidden animate-spin h-4 w-4 mr-1 border-2 border-white border-t-transparent rounded-full"></span>
                    Publish
                </button>
            </div>
        </header>

        <main class="lg:grid lg:grid-cols-3 lg:gap-8">

            <div class="lg:col-span-2">
                <nav id="multi-step-tabs" class="mb-6 border-b border-gray-200 flex">
                    <a href="#step-1" id="tab-1" class="tab tab-active">
                        <i data-lucide="info" class="w-4 h-4 mr-2"></i> Step 1: Event Info
                    </a>
                    <a href="#step-2" id="tab-2" class="tab">
                        <i data-lucide="ticket" class="w-4 h-4 mr-2"></i> Step 2: Reg & Tickets
                    </a>
                </nav>

                <form id="event-creation-form" class="space-y-6 bg-white p-6 rounded-lg shadow-md">
                    
                    <section id="step-1" data-step="1" class="step-content">
                        <h2 class="section-title">Event Basics</h2>
                        
                        <div class="form-group">
                            <label for="event-title">Title <span class="text-red-500">*</span></label>
                            <input type="text" id="event-title" name="title" maxlength="120" placeholder="e.g., ECE TechTalk: VLSI Trends">
                            <div class="char-counter text-right text-xs text-gray-500">0/120</div>
                            <p class="error-message"></p>
                        </div>

                        <div class="form-group">
                            <label for="event-description">Description <span class="text-red-500">*</span></label>
                            <div class="border rounded-md">
                                <div id="editor-toolbar" class="flex p-2 space-x-2 border-b bg-gray-50">
                                    <button type="button" data-command="bold" title="Bold (Ctrl+B)">
                                        <i data-lucide="bold" class="w-4 h-4"></i>
                                    </button>
                                    <button type="button" data-command="italic" title="Italic (Ctrl+I)">
                                        <i data-lucide="italic" class="w-4 h-4"></i>
                                    </button>
                                    <button type="button" data-command="insertUnorderedList" title="Bullet List">
                                        <i data-lucide="list" class="w-4 h-4"></i>
                                    </button>
                                    <button type="button" data-command="createLink" title="Hyperlink">
                                        <i data-lucide="link" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div id="event-description-editor" contenteditable="true" role="textbox" aria-multiline="true" aria-label="Event Description" class="min-h-[150px] p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" data-placeholder="Describe the event, agenda, and speakers..."></div>
                            </div>
                            <div class="char-counter text-right text-xs text-gray-500">0/2000</div>
                            <p class="error-message"></p>
                        </div>

                        <div class="grid sm:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="start-date">Start Date & Time <span class="text-red-500">*</span></label>
                                <input type="datetime-local" id="start-date" name="start_date">
                                <p class="error-message"></p>
                            </div>
                            <div class="form-group">
                                <label for="end-date">End Date & Time <span class="text-red-500">*</span></label>
                                <input type="datetime-local" id="end-date" name="end_date">
                                <p class="error-message"></p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="block mb-2">Location Type <span class="text-red-500">*</span></label>
                            <div class="flex space-x-4">
                                <label class="radio-label">
                                    <input type="radio" name="location-type" value="offline" checked> Offline
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="location-type" value="online"> Online
                                </label>
                            </div>
                            <div id="location-fields" class="mt-3">
                                <div id="offline-field" class="form-group">
                                    <label for="venue">Venue Address <span class="text-red-500">*</span></label>
                                    <input type="text" id="venue" name="venue" placeholder="e.g., Seminar Hall A, ECE Block">
                                    <p class="error-message"></p>
                                </div>
                                <div id="online-field" class="form-group hidden">
                                    <label for="online-url">Online URL (e.g., Zoom/Google Meet) <span class="text-red-500">*</span></label>
                                    <input type="url" id="online-url" name="online_url" placeholder="https://meet.google.com/...">
                                    <p class="error-message"></p>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tags-input">Tags (Max 5)</label>
                            <div id="tags-container" class="border p-2 rounded-md flex flex-wrap gap-2 items-center min-h-[40px] focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500 transition duration-150">
                                <input type="text" id="tags-input" class="flex-grow focus:outline-none p-0 border-none" placeholder="Add a tag (e.g., AI, Workshop)" aria-label="Tags input">
                            </div>
                            <p class="error-message"></p>
                        </div>

                        <div class="form-group">
                            <label for="poster-upload">Poster Image (Required, ≤5MB) <span class="text-red-500">*</span></label>
                            <input type="file" id="poster-upload" name="poster" accept="image/*" class="file-input">
                            <div id="poster-preview" class="mt-2 h-40 w-40 border rounded-lg bg-gray-100 flex items-center justify-center text-gray-400 text-sm overflow-hidden hidden">
                                <img id="preview-poster-img" src="" alt="Poster Preview" class="object-cover w-full h-full hidden">
                                <i data-lucide="image" class="w-10 h-10 text-gray-400"></i>
                            </div>
                            <p class="error-message"></p>
                        </div>

                        <div class="form-group">
                            <label for="brochure-upload">Brochure (Optional, PDF ≤10MB)</label>
                            <input type="file" id="brochure-upload" name="brochure" accept="application/pdf" class="file-input">
                            <p class="error-message"></p>
                        </div>

                    </section>
                    
                    <section id="step-2" data-step="2" class="step-content hidden">
                        <h2 class="section-title">Registration & Tickets</h2>

                        <div class="form-group">
                            <label class="block mb-2">Event Type</label>
                            <div class="flex space-x-4">
                                <label class="radio-label">
                                    <input type="radio" name="recurrence-type" value="single" checked> Single Event
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="recurrence-type" value="recurring"> Recurring Event
                                </label>
                            </div>
                            <div id="recurrence-options" class="mt-3 p-3 border rounded-md hidden">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label for="recurrence-frequency">Repeats</label>
                                        <select id="recurrence-frequency" name="recurrence_frequency">
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="recurrence-interval">Interval</label>
                                        <input type="number" id="recurrence-interval" name="recurrence_interval" min="1" value="1">
                                    </div>
                                </div>
                                <div class="form-group mt-3">
                                    <label>Ends</label>
                                    <div class="flex flex-wrap items-center space-x-4 space-y-2 md:space-y-0">
                                        <label class="radio-label flex items-center">
                                            <input type="radio" name="recurrence-end" value="after" checked> After
                                            <input type="number" name="recurrence_end_after" id="recurrence_end_after" class="w-20 ml-2" min="1" value="6"> occurrences
                                        </label>
                                        <label class="radio-label flex items-center">
                                            <input type="radio" name="recurrence-end" value="until"> Until
                                            <input type="date" name="recurrence_end_until" id="recurrence_end_until" class="ml-2">
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h3 class="subsection-title">Registration Settings</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="capacity">Max Participants <span class="text-red-500">*</span></label>
                                <input type="number" id="capacity" name="capacity" min="1" max="9999" value="250">
                                <p class="error-message"></p>
                            </div>
                            <div class="form-group">
                                <label for="deadline">Registration Deadline <span class="text-red-500">*</span></label>
                                <input type="datetime-local" id="deadline" name="registration_deadline">
                                <p class="error-message"></p>
                            </div>
                        </div>

                        <div class="form-group flex items-center space-x-4">
                            <label class="switch-label relative inline-block w-11 h-6">
                                <input type="checkbox" id="waitlist-toggle" name="waitlist" class="opacity-0 w-0 h-0">
                                <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-gray-300 transition-colors duration-400 rounded-full">
                                    <span class="absolute content-[''] h-4 w-4 left-1 bottom-1 bg-white transition-transform duration-400 rounded-full shadow-md"></span>
                                </span>
                            </label>
                            <label for="waitlist-toggle" class="text-sm cursor-pointer">Enable Waitlist (after max capacity is reached)</label>
                        </div>
                        <style>
                            /* Switch Toggle CSS */
                            .switch-label input:checked + .slider { background-color: #2563EB; }
                            .switch-label input:checked + .slider > span { transform: translateX(20px); }
                        </style>

                        <h3 class="subsection-title mt-6">Ticket Tiers</h3>
                        <div id="ticket-tiers-container" class="space-y-4">
                            </div>

                        <button type="button" id="add-tier-btn" class="mt-4 border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition duration-150 flex items-center justify-center">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Add Ticket Tier
                        </button>
                    </section>

                    <div class="flex justify-between pt-4 border-t border-gray-200">
                        <button type="button" id="prev-step-btn" class="btn-secondary" disabled>
                            <i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i> Previous
                        </button>
                        <button type="button" id="next-step-btn" class="btn-primary">
                            Next <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                        </button>
                    </div>

                </form>
            </div>

            <aside id="preview-sidebar" class="lg:col-span-1 mt-8 lg:mt-0">
                <div class="sticky lg:top-8 p-4 border rounded-lg bg-white shadow-xl">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2">Event Preview</h3>
                    
                    <button id="mobile-preview-toggle" class="lg:hidden btn-secondary mb-3 w-full" data-state="collapsed" aria-expanded="false" aria-controls="event-preview-content">
                        Show Preview
                    </button>

                    <div id="event-preview-content" class="space-y-4 hidden-mobile lg:block" aria-live="polite">
                        <div id="preview-poster" class="h-40 w-full bg-gray-200 rounded-lg mb-3 overflow-hidden flex items-center justify-center">
                            <img id="preview-poster-img-sidebar" src="" alt="Poster Preview" class="object-cover w-full h-full hidden">
                            <i data-lucide="image" class="w-10 h-10 text-gray-400" id="poster-placeholder-icon"></i>
                        </div>
                        
                        <div id="preview-skeleton" class="animate-pulse space-y-3 hidden">
                            <div class="h-6 bg-gray-200 rounded w-full"></div>
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                        </div>

                        <h4 id="preview-title" class="text-xl font-bold">New Event Title</h4>
                        
                        <div class="text-sm space-y-1">
                            <p class="flex items-center text-gray-600"><i data-lucide="calendar" class="w-4 h-4 mr-2"></i> <span id="preview-dates">Date & Time TBA</span></p>
                            <p class="flex items-center text-gray-600"><i data-lucide="map-pin" class="w-4 h-4 mr-2"></i> <span id="preview-location">Location TBA</span></p>
                            <p id="preview-recurrence" class="flex items-center text-gray-600"><i data-lucide="repeat-2" class="w-4 h-4 mr-2"></i> Single Event</p>
                        </div>
                        
                        <div class="border-t pt-3">
                            <p class="font-semibold mb-2">Ticket Tiers</p>
                            <ul id="preview-tickets" class="space-y-1 text-sm">
                                </ul>
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        lucide.createIcons();
    </script>
    
    <script>
        // app.js

        const LOCAL_STORAGE_KEY = 'ece_event_draft';
        let currentStep = 1;
        let eventData = {}; // Main object to hold form state
        let ticketTierCounter = 1; // Used for unique IDs for ticket tiers
        const MAX_TAGS = 5;

        // --- UTILITY FUNCTIONS (TOAST/SNACKBAR) ---

        /** Shows a transient notification. */
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const colors = {
                'success': 'bg-green-500 border-green-700',
                'error': 'bg-red-500 border-red-700',
                'info': 'bg-blue-500 border-blue-700',
            };
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'alert-triangle' : 'info';

            const toast = document.createElement('div');
            toast.className = `p-3 rounded-lg text-white shadow-xl ${colors[type]} flex items-center space-x-2 transition-all duration-300 opacity-0 transform translate-x-10`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span>${message}</span>`;
            
            container.appendChild(toast);
            lucide.createIcons(); 
            
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-10');
                toast.classList.add('opacity-100', 'translate-x-0');
            }, 50);

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-10');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        /** Shows a persistent notification (e.g., for undo). */
        function showSnackbar(message, actionText, actionCallback) {
            const container = document.getElementById('snackbar-container');
            container.innerHTML = ''; 

            const snackbar = document.createElement('div');
            snackbar.className = 'bg-gray-800 text-white px-6 py-3 rounded-lg shadow-2xl flex items-center justify-between space-x-4 opacity-0 transform translate-y-full transition-all duration-300';
            snackbar.setAttribute('role', 'status');
            snackbar.setAttribute('aria-live', 'polite');
            snackbar.innerHTML = `
                <span>${message}</span>
                ${actionText ? `<button class="text-blue-400 font-semibold hover:text-blue-300 transition" id="snackbar-action">${actionText}</button>` : ''}
            `;

            container.appendChild(snackbar);
            
            setTimeout(() => {
                snackbar.classList.remove('opacity-0', 'translate-y-full');
                snackbar.classList.add('opacity-100', 'translate-y-0');
            }, 50);

            if (actionText) {
                document.getElementById('snackbar-action').onclick = () => {
                    actionCallback();
                    snackbar.remove();
                };
            }
            // Auto-hide after 8 seconds
            setTimeout(() => {
                snackbar.classList.add('opacity-0', 'translate-y-full');
                snackbar.addEventListener('transitionend', () => snackbar.remove());
            }, 8000);
        }

        // --- AUTOSAVE & INITIALIZATION ---

        function updateAutosaveTimestamp() {
            const tsEl = document.getElementById('autosave-timestamp');
            const now = new Date();
            tsEl.textContent = `Draft saved ${now.toLocaleTimeString()}`;
        }

        function populateComplexFields(data) {
            // Title Char Counter
            const titleInput = document.getElementById('event-title');
            if (titleInput) {
                titleInput.value = data.title || '';
                titleInput.closest('.form-group').querySelector('.char-counter').textContent = `${data.title.length}/120`;
            }

            // Description Editor
            const editor = document.getElementById('event-description-editor');
            if (editor && data.description_html) {
                editor.innerHTML = data.description_html;
                editor.closest('.form-group').querySelector('.char-counter').textContent = `${editor.textContent.length}/2000`;
            }
            
            // Location Radio Button
            document.querySelectorAll(`input[name="location-type"][value="${data.location_type}"]`).forEach(radio => {
                radio.checked = true;
                radio.dispatchEvent(new Event('change')); // Trigger visibility logic
            });

            // Recurrence Radio Button
            document.querySelectorAll(`input[name="recurrence-type"][value="${data.recurrence_type}"]`).forEach(radio => {
                radio.checked = true;
                radio.dispatchEvent(new Event('change'));
            });
            
            // Waitlist Toggle
            const waitlistToggle = document.getElementById('waitlist-toggle');
            waitlistToggle.checked = data.waitlist || false;
            
            // Tags (Handled by renderTags)
            // Tickets (Handled by renderTicketFormTiers)
        }

        function loadDraft() {
            const draft = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (draft) {
                const loadedData = JSON.parse(draft);
                eventData = loadedData;
                
                showSnackbar('Draft loaded successfully.', 'Undo', () => {
                    // Simple undo: revert eventData to initial state and reload form
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    window.location.reload();
                });
                
                // Populate all fields
                document.getElementById('event-creation-form').reset(); // Reset first
                const allInputs = document.querySelectorAll('#event-creation-form input, #event-creation-form select');
                allInputs.forEach(input => {
                    const key = input.name || input.id.replace(/-/g, '_');
                    if (loadedData[key] !== undefined) {
                        if (input.type === 'checkbox') {
                            input.checked = loadedData[key];
                        } else {
                            input.value = loadedData[key];
                        }
                    }
                });

                populateComplexFields(loadedData);
            } else {
                // Initialize with default empty state
                eventData = {
                    title: '', description_html: '', tags: [],
                    location_type: 'offline', venue: '', online_url: '',
                    capacity: 250, waitlist: false,
                    recurrence_type: 'single', 
                    ticket_tiers: [{ id: 1, name: 'General Admission', price: 200, capacity: null }]
                };
            }
            // Ensure ticketTierCounter is high enough if tiers were loaded
            if (eventData.ticket_tiers && eventData.ticket_tiers.length > 0) {
                 ticketTierCounter = Math.max(...eventData.ticket_tiers.map(t => t.id), 1);
            }
            
            updateAutosaveTimestamp();
        }

        function autoSave() {
            collectFormData();
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(eventData));
            updateAutosaveTimestamp();
        }

        function collectFormData() {
            const form = document.getElementById('event-creation-form');
            const data = new FormData(form);

            eventData.title = data.get('title') || '';
            eventData.description_html = document.getElementById('event-description-editor').innerHTML;
            eventData.start_date = data.get('start_date') || '';
            eventData.end_date = data.get('end_date') || '';
            eventData.location_type = data.get('location-type');
            
            if (eventData.location_type === 'offline') {
                eventData.venue = data.get('venue') || '';
                delete eventData.online_url;
            } else {
                eventData.online_url = data.get('online_url') || '';
                delete eventData.venue;
            }

            // Step 2 Data
            eventData.capacity = parseInt(data.get('capacity') || 0);
            eventData.registration_deadline = data.get('registration_deadline') || '';
            eventData.waitlist = document.getElementById('waitlist-toggle').checked;
            
            eventData.recurrence_type = data.get('recurrence-type');
            if (eventData.recurrence_type === 'recurring') {
                eventData.recurrence = {
                    frequency: data.get('recurrence_frequency'),
                    interval: parseInt(data.get('recurrence_interval') || 1),
                    end_condition: data.get('recurrence-end'),
                    end_after: parseInt(data.get('recurrence_end_after') || 1),
                    end_until: data.get('recurrence_end_until')
                };
            } else {
                delete eventData.recurrence;
            }
        }

        // --- VALIDATION LOGIC ---

        function showValidationError(element, message) {
            if (element.id === 'event-description-editor') {
                 element.classList.add('border-red-500'); // RT editor border
            } else {
                 element.closest('div[class*="form-group"]').querySelector('input, select')?.classList.add('border-red-500');
            }
           
            const errorEl = element.closest('.form-group')?.querySelector('.error-message');
            if (errorEl) {
                errorEl.textContent = message;
            }
        }

        function clearValidationError(element) {
            if (element.id === 'event-description-editor') {
                 element.classList.remove('border-red-500');
            } else {
                 element.closest('div[class*="form-group"]').querySelector('input, select')?.classList.remove('border-red-500');
            }
            const errorEl = element.closest('.form-group')?.querySelector('.error-message');
            if (errorEl) {
                errorEl.textContent = '';
            }
        }

        function validateStep(step) {
            let isValid = true;
            const stepEl = document.getElementById(`step-${step}`);
            collectFormData(); // Ensure eventData is fresh for location/recurrence checks
            
            // Function to get the correct element for error display
            const getErrorElement = (name) => {
                let el = document.getElementById(name.replace(/_/g, '-'));
                if (!el) {
                    if (name === 'venue') el = document.getElementById('venue');
                    if (name === 'online_url') el = document.getElementById('online-url');
                }
                return el || document.querySelector(`[name="${name}"]`) || document.getElementById('event-creation-form');
            };

            // 1. Title/Description/Dates
            if (step === 1) {
                // Title
                const titleEl = getErrorElement('title');
                if (!eventData.title) { showValidationError(titleEl, 'Title is required.'); isValid = false; } 
                else if (eventData.title.length > 120) { showValidationError(titleEl, 'Max 120 characters.'); isValid = false; }
                else { clearValidationError(titleEl); }

                // Description
                const descEl = getErrorElement('event-description-editor');
                const textLength = descEl.textContent.trim().length;
                if (!descEl.textContent.trim()) { showValidationError(descEl, 'Description is required.'); isValid = false; } 
                else if (textLength > 2000) { showValidationError(descEl, 'Max 2000 characters.'); isValid = false; }
                else { clearValidationError(descEl); }

                // Dates
                const startEl = getErrorElement('start_date');
                const endEl = getErrorElement('end_date');
                const startDate = eventData.start_date ? new Date(eventData.start_date) : null;
                const endDate = eventData.end_date ? new Date(eventData.end_date) : null;
                const now = new Date();
                
                if (!startDate) { showValidationError(startEl, 'Start date is required.'); isValid = false; } 
                else if (startDate < now) { showValidationError(startEl, 'Cannot be in the past.'); isValid = false; }
                else { clearValidationError(startEl); }

                if (!endDate) { showValidationError(endEl, 'End date is required.'); isValid = false; } 
                else if (startDate && endDate <= startDate) { showValidationError(endEl, 'Must be after start date.'); isValid = false; }
                else { clearValidationError(endEl); }
                
                // Location
                const locationKey = eventData.location_type === 'offline' ? 'venue' : 'online_url';
                const locationValue = eventData[locationKey];
                const locationEl = getErrorElement(locationKey);
                if (!locationValue) {
                    showValidationError(locationEl, `The ${eventData.location_type} address/URL is required.`);
                    isValid = false;
                } else {
                    clearValidationError(locationEl);
                }
                
                // Poster
                const posterInput = document.getElementById('poster-upload');
                if (posterInput.files.length === 0 && !eventData.poster_url) {
                    showValidationError(posterInput, 'A poster image is required.');
                    isValid = false;
                } else {
                    clearValidationError(posterInput);
                }
            } 
            
            // 2. Registration/Tickets
            if (step === 2) {
                // Capacity
                const capEl = getErrorElement('capacity');
                if (eventData.capacity <= 0 || eventData.capacity > 9999 || isNaN(eventData.capacity)) { 
                    showValidationError(capEl, 'Must be a positive number (max 9999).'); isValid = false; 
                } else { clearValidationError(capEl); }
                
                // Deadline
                const deadlineEl = getErrorElement('registration_deadline');
                const deadlineDate = eventData.registration_deadline ? new Date(eventData.registration_deadline) : null;
                const startDate = eventData.start_date ? new Date(eventData.start_date) : null;

                if (!deadlineDate) { showValidationError(deadlineEl, 'Deadline is required.'); isValid = false; } 
                else if (startDate && deadlineDate >= startDate) { showValidationError(deadlineEl, 'Must be before start date.'); isValid = false; }
                else { clearValidationError(deadlineEl); }
            }

            return isValid;
        }

        // --- MULTI-STEP NAVIGATION ---

        function updateStepUI() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('tab-active');
                if (tab.id === `tab-${currentStep}`) {
                    tab.classList.add('tab-active');
                }
            });

            document.querySelectorAll('.step-content').forEach(section => {
                section.classList.add('hidden');
                if (parseInt(section.dataset.step) === currentStep) {
                    section.classList.remove('hidden');
                }
            });
            
            document.getElementById('prev-step-btn').disabled = currentStep === 1;
            const nextBtn = document.getElementById('next-step-btn');
            
            // At the last step, the "Next" button should not be primary navigation
            if (currentStep === 2) {
                nextBtn.textContent = 'Review';
                nextBtn.classList.remove('btn-primary');
                nextBtn.classList.add('btn-secondary');
                nextBtn.disabled = true; 
            } else {
                nextBtn.textContent = 'Next';
                nextBtn.classList.remove('btn-secondary');
                nextBtn.classList.add('btn-primary');
                nextBtn.disabled = false;
            }
            
            // Scroll to top of form when navigating
            document.getElementById('event-creation-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function goToStep(step) {
            if (step < currentStep) {
                currentStep = step;
                updateStepUI();
            } else if (step > currentStep) {
                if (validateStep(currentStep)) {
                    currentStep = step;
                    updateStepUI();
                } else {
                    showToast('Please fix the highlighted errors before proceeding.', 'error');
                }
            }
        }

        // --- REALTIME PREVIEW ---

        function generateRecurrenceSummary(recurrence) {
            if (!recurrence || eventData.recurrence_type === 'single') return 'Single Event';
            
            let summary = `Repeats ${recurrence.frequency}`;
            if (recurrence.interval > 1) {
                summary += ` every ${recurrence.interval}`;
            }
            
            if (recurrence.end_condition === 'after') {
                summary += `, ends after ${recurrence.end_after} occurrences.`;
            } else if (recurrence.end_condition === 'until' && recurrence.end_until) {
                summary += `, until ${new Date(recurrence.end_until).toLocaleDateString()}`;
            }
            return summary;
        }

        function renderTicketTiers() {
            const container = document.getElementById('preview-tickets');
            container.innerHTML = '';
            
            if (eventData.ticket_tiers && eventData.ticket_tiers.length > 0) {
                eventData.ticket_tiers.forEach(tier => {
                    const price = tier.price === 0 ? 'Free' : `₹${tier.price}`;
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between transition-opacity duration-300';
                    listItem.innerHTML = `
                        <span>${tier.name}</span>
                        <span class="font-medium">${price}</span>
                    `;
                    container.appendChild(listItem);
                });
            } else {
                 container.innerHTML = '<li class="text-gray-400">No ticket tiers defined.</li>';
            }
        }

        function updatePreview() {
            collectFormData(); 

            // Update Title
            document.getElementById('preview-title').textContent = eventData.title || 'New Event Title';
            
            // Update Dates
            const start = eventData.start_date ? new Date(eventData.start_date).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) : 'Date & Time TBA';
            document.getElementById('preview-dates').textContent = start;
            
            // Update Location
            let locationText = 'Location TBA';
            let locationIcon = 'map-pin';
            if (eventData.location_type === 'offline' && eventData.venue) {
                locationText = eventData.venue;
            } else if (eventData.location_type === 'online' && eventData.online_url) {
                locationText = 'Online Event';
                locationIcon = 'monitor';
            }
            const locationEl = document.getElementById('preview-location');
            locationEl.textContent = locationText;
            locationEl.previousElementSibling.setAttribute('data-lucide', locationIcon);
            lucide.createIcons();

            // Update Recurrence Summary
            document.getElementById('preview-recurrence').textContent = generateRecurrenceSummary(eventData.recurrence);

            // Update Tickets
            renderTicketTiers();
        }

        // --- INITIALIZE LISTENERS ---

        function initializeListeners() {
            // --- Step Navigation Listeners ---
            document.getElementById('next-step-btn').addEventListener('click', () => goToStep(currentStep + 1));
            document.getElementById('prev-step-btn').addEventListener('click', () => goToStep(currentStep - 1));
            document.getElementById('tab-1').addEventListener('click', (e) => { e.preventDefault(); goToStep(1); });
            document.getElementById('tab-2').addEventListener('click', (e) => { e.preventDefault(); goToStep(2); });

            // --- Header Actions ---
            document.getElementById('save-draft-btn').addEventListener('click', () => {
                autoSave();
                showToast('Draft saved successfully!', 'success');
            });

            document.getElementById('publish-btn').addEventListener('click', (e) => {
                const spinner = document.getElementById('publish-spinner');
                
                if (!validateStep(1) || !validateStep(2)) {
                    showToast('Validation failed. See errors in the form.', 'error');
                    // Automatically jump to the first invalid step
                    if (!validateStep(1)) goToStep(1); else goToStep(2);
                    return;
                }

                // Simulate publish process
                spinner.classList.remove('hidden');
                e.target.disabled = true;
                
                setTimeout(() => {
                    spinner.classList.add('hidden');
                    e.target.disabled = false;
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    showToast('Event published successfully!', 'success', 6000);
                    // Reset form and data after publishing
                    window.location.reload(); 
                }, 3000);
            });
            
            // --- Form Field Listeners (Input/Change for Autosave & Preview) ---
            document.getElementById('event-creation-form').addEventListener('input', (e) => {
                clearTimeout(window.autosaveTimer);
                window.autosaveTimer = setTimeout(autoSave, 1500);

                if (['title', 'start_date', 'end_date', 'venue', 'online_url', 'recurrence_frequency', 'recurrence_end_after', 'recurrence_end_until', 'location-type', 'recurrence-type'].includes(e.target.name || e.target.id)) {
                    updatePreview();
                }
                
                // Character counters
                if (e.target.id === 'event-title') {
                    e.target.closest('.form-group').querySelector('.char-counter').textContent = `${e.target.value.length}/120`;
                }
            });

            // --- Location/Recurrence Toggles Listener ---
            document.querySelectorAll('input[name="location-type"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    document.getElementById('offline-field').classList.add('hidden');
                    document.getElementById('online-field').classList.add('hidden');
                    if (e.target.value === 'offline') {
                        document.getElementById('offline-field').classList.remove('hidden');
                    } else {
                        document.getElementById('online-field').classList.remove('hidden');
                    }
                    updatePreview();
                });
            });

            document.querySelectorAll('input[name="recurrence-type"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    document.getElementById('recurrence-options').classList.toggle('hidden', e.target.value === 'single');
                    updatePreview();
                });
            });

            // --- Tags Input Listener ---
            const tagsContainer = document.getElementById('tags-container');
            const tagsInput = document.getElementById('tags-input');

            const renderTags = () => {
                tagsContainer.querySelectorAll('.tag-item').forEach(tag => tag.remove());
                
                eventData.tags.forEach(tagText => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'tag-item bg-blue-100 text-blue-800 text-sm font-medium px-2 py-1 rounded-full flex items-center space-x-1';
                    tagEl.innerHTML = `<span>${tagText}</span><button type="button" class="tag-remove" data-tag="${tagText}"><i data-lucide="x" class="w-3 h-3 text-blue-600 hover:text-blue-800"></i></button>`;
                    tagsContainer.insertBefore(tagEl, tagsInput);
                });
                lucide.createIcons();
                tagsInput.placeholder = eventData.tags.length < MAX_TAGS ? 'Add a tag (e.g., AI, Workshop)' : 'Max tags reached (5)';
                tagsInput.disabled = eventData.tags.length >= MAX_TAGS;
                autoSave();
            };
            window.renderTags = renderTags; // Make it globally accessible for initial load

            tagsInput.addEventListener('keydown', (e) => {
                const value = tagsInput.value.trim();
                // Add tag on Enter/Comma
                if ((e.key === 'Enter' || e.key === ',') && value) {
                    e.preventDefault();
                    if (eventData.tags.length < MAX_TAGS && !eventData.tags.includes(value)) {
                        eventData.tags.push(value);
                        tagsInput.value = '';
                        renderTags();
                    } else if (eventData.tags.length >= MAX_TAGS) {
                        showToast('Maximum 5 tags allowed.', 'info');
                    }
                }
                // Remove tag on Backspace if input is empty
                if (e.key === 'Backspace' && value === '' && eventData.tags.length > 0) {
                    eventData.tags.pop();
                    renderTags();
                }
            });

            tagsContainer.addEventListener('click', (e) => {
                if (e.target.closest('.tag-remove')) {
                    const tagText = e.target.closest('.tag-remove').dataset.tag;
                    eventData.tags = eventData.tags.filter(tag => tag !== tagText);
                    renderTags();
                }
            });


            // --- File Upload Listeners (Poster/Brochure) ---
            document.getElementById('poster-upload').addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    const previewContainer = document.getElementById('poster-preview');
                    const sidebarImg = document.getElementById('preview-poster-img-sidebar');
                    const localImg = document.getElementById('preview-poster-img');

                    // Size check
                    if (file.size > 5 * 1024 * 1024) {
                        showToast('Poster must be ≤5MB.', 'error');
                        this.value = ''; 
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        localImg.src = e.target.result;
                        sidebarImg.src = e.target.result;
                        localImg.classList.remove('hidden');
                        sidebarImg.classList.remove('hidden');
                        previewContainer.querySelector('i').classList.add('hidden');
                        document.getElementById('poster-placeholder-icon').classList.add('hidden');
                        previewContainer.classList.remove('hidden');
                        eventData.poster_url = e.target.result; // Store for preview purposes
                        autoSave();
                    };
                    reader.readAsDataURL(file);
                } else {
                    eventData.poster_url = null;
                    document.getElementById('preview-poster-img').classList.add('hidden');
                    document.getElementById('preview-poster-img-sidebar').classList.add('hidden');
                    document.getElementById('poster-placeholder-icon').classList.remove('hidden');
                    autoSave();
                }
            });
            
            document.getElementById('brochure-upload').addEventListener('change', function() {
                if (this.files && this.files[0]) {
                     const file = this.files[0];
                     if (file.size > 10 * 1024 * 1024) {
                         showToast('Brochure must be ≤10MB.', 'error');
                         this.value = ''; 
                     } else {
                         showToast(`Brochure (${file.name}) uploaded.`, 'info');
                     }
                }
            });


            // --- Rich Text Editor Listener ---
            const editor = document.getElementById('event-description-editor');
            const charCounter = editor.closest('.form-group').querySelector('.char-counter');

            document.getElementById('editor-toolbar').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.dataset.command) {
                    e.preventDefault();
                    const command = btn.dataset.command;
                    
                    if (command === 'createLink') {
                        const selection = window.getSelection();
                        if (selection.toString().length > 0) {
                            const url = prompt('Enter the URL:', 'https://');
                            if (url) {
                                document.execCommand(command, false, url);
                            }
                        } else {
                             showToast('Please select text to create a link.', 'info');
                        }
                    } else {
                        document.execCommand(command, false, null);
                    }
                    editor.focus();
                }
            });

            // Content update/char count
            editor.addEventListener('input', () => {
                const textLength = editor.textContent.length;
                charCounter.textContent = `${textLength}/2000`;
                if (textLength > 2000) {
                    charCounter.classList.add('text-red-500');
                } else {
                    charCounter.classList.remove('text-red-500');
                }
                updatePreview();
                autoSave();
            });

            // --- Ticket Tier Management ---
            const ticketContainer = document.getElementById('ticket-tiers-container');
            document.getElementById('add-tier-btn').addEventListener('click', () => {
                ticketTierCounter++;
                const newTier = { id: ticketTierCounter, name: `Custom Tier ${ticketTierCounter - 1}`, price: 0, capacity: null };
                eventData.ticket_tiers.push(newTier);
                renderTicketFormTiers(); 
                updatePreview(); 
            });
            
            const renderTicketFormTiers = () => {
                ticketContainer.innerHTML = ''; 
                
                eventData.ticket_tiers.forEach(tier => {
                    const isGeneral = tier.id === 1;
                    const tierHtml = `
                        <div class="ticket-tier p-4 border rounded-md bg-gray-50 transition-opacity duration-300" data-id="${tier.id}">
                            <h4 class="font-medium flex justify-between items-center">
                                <input type="text" name="tier_name" value="${tier.name}" class="text-base font-medium bg-transparent border-none p-0 focus:ring-0 focus:outline-none w-3/4" ${isGeneral ? 'disabled title="General admission name cannot be changed"' : ''}>
                                <button type="button" class="text-red-500 hover:text-red-700 disabled:opacity-50" data-action="remove-tier" ${eventData.ticket_tiers.length === 1 ? 'disabled' : ''} aria-label="Remove ticket tier">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </h4>
                            <div class="grid sm:grid-cols-3 gap-4 mt-2">
                                <div class="form-group col-span-1">
                                    <label for="price-${tier.id}">Price (₹)</label>
                                    <input type="number" id="price-${tier.id}" name="price" value="${tier.price}" min="0">
                                </div>
                                <div class="form-group col-span-2">
                                    <label for="tier-capacity-${tier.id}">Capacity (0 for unlimited)</label>
                                    <input type="number" id="tier-capacity-${tier.id}" name="tier_capacity" value="${tier.capacity !== null ? tier.capacity : ''}" min="0" placeholder="0">
                                </div>
                            </div>
                        </div>
                    `;
                    ticketContainer.insertAdjacentHTML('beforeend', tierHtml);
                });
                lucide.createIcons();
                autoSave();
            }
            window.renderTicketFormTiers = renderTicketFormTiers;

            ticketContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('[data-action="remove-tier"]');
                if (removeBtn && !removeBtn.disabled) {
                    const tierId = parseInt(removeBtn.closest('.ticket-tier').dataset.id);
                    eventData.ticket_tiers = eventData.ticket_tiers.filter(t => t.id !== tierId);
                    renderTicketFormTiers();
                    renderTicketTiers();
                }
            });
            
            ticketContainer.addEventListener('input', (e) => {
                const input = e.target;
                const tierEl = input.closest('.ticket-tier');
                const tierId = parseInt(tierEl.dataset.id);
                const tier = eventData.ticket_tiers.find(t => t.id === tierId);

                if (tier) {
                    if (input.name === 'tier_name') tier.name = input.value;
                    if (input.name === 'price') tier.price = parseInt(input.value || 0);
                    if (input.name === 'tier_capacity') tier.capacity = input.value ? parseInt(input.value) : null;
                    
                    updatePreview(); 
                    autoSave();
                }
            });
            
            // --- Mobile Preview Toggle ---
            document.getElementById('mobile-preview-toggle').addEventListener('click', (e) => {
                const content = document.getElementById('event-preview-content');
                const isCollapsed = e.target.dataset.state === 'collapsed';
                
                if (isCollapsed) {
                    content.classList.remove('hidden-mobile');
                    e.target.dataset.state = 'expanded';
                    e.target.textContent = 'Hide Preview';
                    e.target.setAttribute('aria-expanded', 'true');
                } else {
                    content.classList.add('hidden-mobile');
                    e.target.dataset.state = 'collapsed';
                    e.target.textContent = 'Show Preview';
                    e.target.setAttribute('aria-expanded', 'false');
                }
            });

        }

        // --- MAIN EXECUTION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDraft();
            initializeListeners();
            updateStepUI();
            
            // Render complex UI elements based on loaded data
            renderTags();
            renderTicketFormTiers();
            
            // Re-run preview update to ensure all loaded data is displayed
            updatePreview();
        });
    </script>
</body>
</html>